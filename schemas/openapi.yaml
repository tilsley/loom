openapi: "3.0.3"
info:
  title: Loom Migration API
  version: 0.3.0
  description: Control plane API for orchestrating multi-repo migrations.

paths:
  /migrations:
    get:
      summary: List all migrations
      operationId: listMigrations
      responses:
        "200":
          description: List of migrations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListMigrationsResponse"

  /migrations/{id}:
    get:
      summary: Get a migration
      operationId: getMigration
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Migration details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Migration"
        "404":
          description: Migration not found

  /migrations/{id}/candidates:
    post:
      summary: Submit discovered candidates for a migration
      operationId: submitCandidates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitCandidatesRequest"
      responses:
        "204":
          description: Candidates saved
        "404":
          description: Migration not found
    get:
      summary: List candidates for a migration
      operationId: listCandidates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Candidates with status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Candidate"

  /migrations/{id}/candidates/{candidateId}/start:
    post:
      summary: Start the migration workflow for a single candidate
      operationId: startRun
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartRequest"
      responses:
        "202":
          description: Migration started
        "404":
          description: Migration or candidate not found
        "409":
          description: Candidate already running or completed

  /migrations/{id}/candidates/{candidateId}/cancel:
    post:
      summary: Cancel a running migration for a candidate, resetting it to not_started and recording an attempt
      operationId: cancelRun
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Cancelled
        "404":
          description: Migration or candidate not found
        "409":
          description: Candidate is not running

  /migrations/{id}/candidates/{candidateId}/steps:
    get:
      summary: Get step execution progress for a running or completed candidate
      operationId: getCandidateSteps
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Step execution detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CandidateStepsResponse"
        "404":
          description: No active or completed workflow found for this candidate

  /migrations/{id}/dry-run:
    post:
      summary: Simulate a full migration run for a candidate, returning per-step file diffs
      operationId: dryRunCandidate
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DryRunCandidateRequest"
      responses:
        "200":
          description: Dry run completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DryRunResult"
        "404":
          description: Migration not found

  /event/{id}:
    post:
      summary: Worker callback to resume a paused workflow step
      operationId: raiseEvent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepCompletedEvent"
      responses:
        "202":
          description: Event raised
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventResponse"

components:
  schemas:
    # --- Core domain types ---

    CandidateStatus:
      type: string
      enum: [not_started, running, completed]

    CancelledAttempt:
      type: object
      required: [candidateId, cancelledAt]
      properties:
        candidateId:
          type: string
        cancelledAt:
          type: string
          format: date-time

    InputDefinition:
      type: object
      required: [name, label]
      properties:
        name:
          type: string
          description: Metadata key merged into candidate at start time (e.g. "repoName").
        label:
          type: string
          description: Human-readable display label shown in the UI (e.g. "Repository").

    StepDefinition:
      type: object
      required: [name, workerApp]
      properties:
        name:
          type: string
          description: Unique name for this step within the migration.
        description:
          type: string
        workerApp:
          type: string
          description: Dapr app-id of the worker that handles this step.
        config:
          type: object
          additionalProperties:
            type: string
          description: Arbitrary key-value config forwarded to the worker.

    FileRef:
      type: object
      required: [path, url]
      properties:
        path:
          type: string
          description: File path relative to the repository root.
        url:
          type: string
          description: GitHub URL to view the file (e.g. https://github.com/owner/repo/blob/main/path/to/file).

    FileGroup:
      type: object
      required: [name, repo, files]
      description: >
        A set of files that will be touched by the migration, grouped by context.
      properties:
        name:
          type: string
          description: >
            Group identifier — self-describing context (e.g. "prod", "staging", "dev"
            for overlay environments; "base" for shared GitOps resources; "app-repo"
            for the application's own repository).
        repo:
          type: string
          description: Repository name (without org prefix, e.g. "gitops" or "billing-api").
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileRef"
          description: Files that will be modified, each with a path and a direct GitHub URL.

    Candidate:
      type: object
      required: [id]
      properties:
        id:
          type: string
          description: "Logical identifier for the candidate (e.g. billing-api). Primary key within a migration."
        kind:
          type: string
          description: "Type of thing being migrated (e.g. application, kafka-topic). Free-form string set by the discoverer."
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Descriptive context set by the discoverer (e.g. repoName is the repo name without org prefix, team, system).
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileGroup"
          description: >
            Files this candidate has that will be touched by the migration,
            grouped by environment or repository context. Populated by the discoverer.
        status:
          $ref: "#/components/schemas/CandidateStatus"
          description: Migration status for this candidate. Set and managed by the server; absent means not_started.

    Migration:
      type: object
      required: [id, name, description, candidates, steps, createdAt]
      properties:
        id:
          type: string
          description: Deterministic slug owned by the worker (e.g. "app-chart-migration").
        name:
          type: string
        description:
          type: string
        requiredInputs:
          type: array
          items:
            $ref: '#/components/schemas/InputDefinition'
          description: Input definitions the operator must supply at start time.
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
          description: Targets discovered by the worker; each carries its own migration status.
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"
        createdAt:
          type: string
          format: date-time
        cancelledAttempts:
          type: array
          items:
            $ref: "#/components/schemas/CancelledAttempt"
          description: Audit log of cancelled attempts, in chronological order.

    ListMigrationsResponse:
      type: object
      required: [migrations]
      properties:
        migrations:
          type: array
          items:
            $ref: "#/components/schemas/Migration"

    # --- Request / response types ---

    StartRequest:
      type: object
      properties:
        inputs:
          type: object
          additionalProperties:
            type: string
          description: Operator-supplied inputs collected at preview time. Merged into candidate metadata before starting the workflow.

    CandidateStepsResponse:
      type: object
      required: [status, steps]
      properties:
        status:
          type: string
          enum: [running, completed]
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepResult"

    SubmitCandidatesRequest:
      type: object
      required: [candidates]
      properties:
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"

    # --- Worker contract (pub/sub) ---

    MigrationAnnouncement:
      type: object
      required: [id, name, description, candidates, steps]
      description: >
        Published by workers to the "migration-registry" Dapr topic on startup.
        Loom subscribes and upserts the migration (idempotent by id).
      properties:
        id:
          type: string
          description: Deterministic slug owned by the worker (e.g. "app-chart-migration").
        name:
          type: string
        description:
          type: string
        requiredInputs:
          type: array
          items:
            $ref: '#/components/schemas/InputDefinition'
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"

    MigrationManifest:
      type: object
      required: [migrationId, candidates, steps]
      description: Internal payload for the Temporal workflow.
      properties:
        migrationId:
          type: string
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"

    DispatchStepRequest:
      type: object
      required: [migrationId, stepName, candidate, callbackId, eventName]
      description: Message published to workers via Dapr pub/sub.
      properties:
        migrationId:
          type: string
        stepName:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        config:
          type: object
          additionalProperties:
            type: string
        callbackId:
          type: string
          description: Workflow instance ID — workers POST back to /event/{callbackId}.
        eventName:
          type: string
          description: Exact event name the workflow is waiting on.

    StepCompletedEvent:
      type: object
      required: [stepName, candidate, success]
      properties:
        stepName:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        success:
          type: boolean
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Arbitrary metadata, e.g. prUrl, commitSha.

    StepResult:
      type: object
      required: [stepName, candidate, success]
      properties:
        stepName:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        success:
          type: boolean
        metadata:
          type: object
          additionalProperties:
            type: string

    # --- Dry run ---

    FileDiff:
      type: object
      required: [path, repo, after, status]
      properties:
        path:
          type: string
          description: File path relative to the repository root.
        repo:
          type: string
          description: Repository name (without org prefix, e.g. "billing-api").
        before:
          type: string
          description: Original file content; empty string means the file is new.
        after:
          type: string
          description: New file content after the step would apply.
        status:
          type: string
          enum: [new, modified, deleted]
          description: Whether this file is being created, modified, or deleted by this step.

    StepDryRunResult:
      type: object
      required: [stepName, skipped]
      properties:
        stepName:
          type: string
        skipped:
          type: boolean
          description: >
            True if this step was not executed (e.g. manual-review step
            or step type not registered on this worker).
        error:
          type: string
          description: Error message if the step handler failed.
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileDiff"
          description: File diffs produced by this step; absent if skipped or errored.

    DryRunResult:
      type: object
      required: [steps]
      properties:
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDryRunResult"

    DryRunCandidateRequest:
      type: object
      required: [candidate]
      properties:
        candidate:
          $ref: "#/components/schemas/Candidate"

    DryRunRequest:
      type: object
      required: [migrationId, candidate, steps]
      description: >
        Payload the server sends to a worker via Dapr service invocation
        to execute a dry run. Contains all steps; the worker skips steps
        that don't belong to it.
      properties:
        migrationId:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"

    # --- Worker callback ---

    EventResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
