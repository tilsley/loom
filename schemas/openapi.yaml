openapi: "3.0.3"
info:
  title: Loom Migration API
  version: 0.3.0
  description: Control plane API for orchestrating multi-repo migrations.

paths:
  /migrations:
    get:
      summary: List all migrations
      operationId: listMigrations
      responses:
        "200":
          description: List of migrations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListMigrationsResponse"

  /migrations/{id}:
    get:
      summary: Get a migration
      operationId: getMigration
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Migration details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Migration"
        "404":
          description: Migration not found

  /migrations/{id}/candidates:
    post:
      summary: Submit discovered candidates for a migration
      operationId: submitCandidates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitCandidatesRequest"
      responses:
        "204":
          description: Candidates saved
        "404":
          description: Migration not found
    get:
      summary: List candidates for a migration
      operationId: listCandidates
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Candidates with status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Candidate"

  /migrations/{id}/candidates/{candidateId}/start:
    post:
      summary: Start the migration workflow for a single candidate
      operationId: startRun
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartRequest"
      responses:
        "202":
          description: Migration started
        "404":
          description: Migration or candidate not found
        "409":
          description: Candidate already running or completed

  /migrations/{id}/candidates/{candidateId}/cancel:
    post:
      summary: Cancel a running migration for a candidate, resetting it to not_started and recording an attempt
      operationId: cancelRun
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Cancelled
        "404":
          description: Migration or candidate not found
        "409":
          description: Candidate is not running

  /migrations/{id}/candidates/{candidateId}/retry-step:
    post:
      summary: Re-dispatch a failed step for a running candidate
      operationId: retryStep
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RetryStepRequest"
      responses:
        "202":
          description: Step retried
        "404":
          description: Migration or candidate not found
        "409":
          description: Candidate is not running

  /migrations/{id}/candidates/{candidateId}/inputs:
    patch:
      summary: Update operator-supplied inputs for a candidate
      operationId: updateCandidateInputs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateInputsRequest"
      responses:
        "204":
          description: Inputs updated
        "400":
          description: Invalid input key
        "404":
          description: Migration or candidate not found

  /migrations/{id}/candidates/{candidateId}/steps:
    get:
      summary: Get step execution progress for a running or completed candidate
      operationId: getCandidateSteps
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: candidateId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Step execution detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CandidateStepsResponse"
        "404":
          description: No active or completed workflow found for this candidate

  /migrations/{id}/dry-run:
    post:
      summary: Simulate a full migration run for a candidate, returning per-step file diffs
      operationId: dryRunCandidate
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DryRunCandidateRequest"
      responses:
        "200":
          description: Dry run completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DryRunResult"
        "404":
          description: Migration not found

  /event/{id}:
    post:
      summary: Migrator callback to resume a paused run step
      operationId: raiseEvent
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StepStatusEvent"
      responses:
        "202":
          description: Event raised
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventResponse"


components:
  schemas:
    # --- Core domain types ---

    CandidateStatus:
      type: string
      enum: [not_started, running, completed]

    InputDefinition:
      type: object
      required: [name, label]
      properties:
        name:
          type: string
          description: Metadata key merged into candidate at start time (e.g. "repoName").
        label:
          type: string
          description: Human-readable display label shown in the UI (e.g. "Repository").
        description:
          type: string
          description: Optional hint shown below the input field (e.g. "Pre-filled from discovery — verify before continuing").

    StepDefinition:
      type: object
      required: [name, migratorApp]
      properties:
        name:
          type: string
          description: Unique name for this step within the migration.
        description:
          type: string
        migratorApp:
          type: string
          description: App-id of the migrator that handles this step (matches the id the migrator announces).
        type:
          type: string
          description: Optional step type identifier (e.g. "manual-review"). Used by the UI to render step-type-specific controls.
        config:
          type: object
          additionalProperties:
            type: string
          description: Arbitrary key-value config forwarded to the migrator.

    FileRef:
      type: object
      required: [path, url]
      properties:
        path:
          type: string
          description: File path relative to the repository root.
        url:
          type: string
          description: GitHub URL to view the file (e.g. https://github.com/owner/repo/blob/main/path/to/file).

    FileGroup:
      type: object
      required: [name, repo, files]
      description: >
        A set of files that will be touched by the migration, grouped by context.
      properties:
        name:
          type: string
          description: >
            Group identifier — self-describing context (e.g. "prod", "staging", "dev"
            for overlay environments; "base" for shared GitOps resources; "app-repo"
            for the application's own repository).
        repo:
          type: string
          description: Repository name (without org prefix, e.g. "gitops" or "billing-api").
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileRef"
          description: Files that will be modified, each with a path and a direct GitHub URL.

    Candidate:
      type: object
      required: [id, kind, status]
      properties:
        id:
          type: string
          description: "Logical identifier for the candidate (e.g. billing-api). Primary key within a migration."
        kind:
          type: string
          description: "Type of thing being migrated (e.g. application, kafka-topic). Free-form string set by the discoverer."
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Descriptive context set by the discoverer (e.g. repoName is the repo name without org prefix, team, system).
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileGroup"
          description: >
            Files this candidate has that will be touched by the migration,
            grouped by environment or repository context. Populated by the discoverer.
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"
          description: >
            The ordered steps that apply to this specific candidate, computed at discovery time.
            When present, the workflow uses these instead of the migration-level step list,
            allowing each candidate to have a tailored workflow based on what was discovered
            (e.g. only the environments where the candidate actually exists).
        status:
          $ref: "#/components/schemas/CandidateStatus"
          default: not_started
          description: Migration status for this candidate. Set and managed by the server.

    Migration:
      type: object
      required: [id, name, description, candidates, steps, createdAt, migratorUrl]
      properties:
        id:
          type: string
          description: Deterministic slug owned by the migrator (e.g. "app-chart-migration").
        name:
          type: string
        description:
          type: string
        overview:
          type: array
          items:
            type: string
          description: >
            Optional human-readable overview of what this migration does, authored by the migrator.
            Each string describes one high-level phase. Shown on the migration detail page.
        migratorUrl:
          type: string
          description: Base URL the server uses to dispatch steps and invoke dry-run (e.g. http://app-chart-migrator:3001).
        requiredInputs:
          type: array
          items:
            $ref: '#/components/schemas/InputDefinition'
          description: Input definitions the operator must supply at start time.
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
          description: Targets discovered by the migrator; each carries its own migration status.
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"
        createdAt:
          type: string
          format: date-time

    ListMigrationsResponse:
      type: object
      required: [migrations]
      properties:
        migrations:
          type: array
          items:
            $ref: "#/components/schemas/Migration"

    # --- Request / response types ---

    RetryStepRequest:
      type: object
      required: [stepName]
      properties:
        stepName:
          type: string
          description: Name of the failed step to retry.

    StartRequest:
      type: object
      properties:
        inputs:
          type: object
          additionalProperties:
            type: string
          description: Operator-supplied inputs collected at preview time. Merged into candidate metadata before starting the workflow.

    UpdateInputsRequest:
      type: object
      required: [inputs]
      properties:
        inputs:
          type: object
          additionalProperties:
            type: string
          description: Operator-supplied input values to update. Keys must match entries in migration.requiredInputs.

    CandidateStepsResponse:
      type: object
      required: [status, steps]
      properties:
        status:
          type: string
          enum: [running, completed]
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepState"

    SubmitCandidatesRequest:
      type: object
      required: [candidates]
      properties:
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"

    # --- Worker contract (pub/sub) ---

    MigrationAnnouncement:
      type: object
      required: [id, name, description, candidates, steps, migratorUrl]
      description: >
        POSTed by migrators directly to /registry/announce on startup.
        Loom upserts the migration (idempotent by id) and registers the migrator URL.
      properties:
        id:
          type: string
          description: Deterministic slug owned by the migrator (e.g. "app-chart-migration").
        name:
          type: string
        description:
          type: string
        overview:
          type: array
          items:
            type: string
          description: >
            Optional human-readable overview of what this migration does, authored by the migrator.
            Each string describes one high-level phase. Shown on the migration detail page.
        requiredInputs:
          type: array
          items:
            $ref: '#/components/schemas/InputDefinition'
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"
        migratorUrl:
          type: string
          description: Base URL the server uses to dispatch steps and invoke dry-run (e.g. http://app-chart-migrator:3001).

    MigrationManifest:
      type: object
      required: [migrationId, candidates, steps, migratorUrl]
      description: Internal payload for the Temporal workflow.
      properties:
        migrationId:
          type: string
        migratorUrl:
          type: string
          description: Base URL the server uses to dispatch steps to the migrator.
        candidates:
          type: array
          items:
            $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"

    DispatchStepRequest:
      type: object
      required: [migrationId, stepName, candidate, callbackId, eventName, migratorApp, migratorUrl]
      description: Posted directly to a migrator's /dispatch-step endpoint by the server.
      properties:
        migrationId:
          type: string
        stepName:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        config:
          type: object
          additionalProperties:
            type: string
        callbackId:
          type: string
          description: Workflow instance ID — migrators POST back to /event/{callbackId}.
        eventName:
          type: string
          description: Exact event name the workflow is waiting on.
        migratorApp:
          type: string
          description: App-id of the migrator handling this step (e.g. app-chart-migrator).
        migratorUrl:
          type: string
          description: Base URL of the migrator (e.g. http://app-chart-migrator:3001). Used by the notifier to POST the request.
        type:
          type: string
          description: Step type identifier forwarded from StepDefinition.type (e.g. "manual-review"). Used by the migrator to route to the correct handler.

    StepStatusEvent:
      type: object
      required: [stepName, candidateId, status]
      properties:
        stepName:
          type: string
        candidateId:
          type: string
          description: ID of the candidate this event is for.
        status:
          type: string
          enum: [succeeded, failed, pending, merged]
          description: Terminal or intermediate status of the step. pending keeps the workflow waiting; succeeded, merged, and failed advance it.
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Arbitrary metadata, e.g. prUrl, commitSha.

    StepState:
      type: object
      required: [stepName, candidate, status]
      properties:
        stepName:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        status:
          type: string
          enum: [in_progress, pending, succeeded, merged, failed]
          description: Lifecycle state of the step.
        metadata:
          type: object
          additionalProperties:
            type: string

    # --- Dry run ---

    FileDiff:
      type: object
      required: [path, repo, after, status]
      properties:
        path:
          type: string
          description: File path relative to the repository root.
        repo:
          type: string
          description: Repository name (without org prefix, e.g. "billing-api").
        before:
          type: string
          description: Original file content; empty string means the file is new.
        after:
          type: string
          description: New file content after the step would apply.
        status:
          type: string
          enum: [new, modified, deleted]
          description: Whether this file is being created, modified, or deleted by this step.

    StepDryRunResult:
      type: object
      required: [stepName, skipped]
      properties:
        stepName:
          type: string
        skipped:
          type: boolean
          description: >
            True if this step was not executed (e.g. manual-review step
            or step type not registered on this migrator).
        error:
          type: string
          description: Error message if the step handler failed.
        files:
          type: array
          items:
            $ref: "#/components/schemas/FileDiff"
          description: File diffs produced by this step; absent if skipped or errored.

    DryRunResult:
      type: object
      required: [steps]
      properties:
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDryRunResult"

    DryRunCandidateRequest:
      type: object
      required: [candidate]
      properties:
        candidate:
          $ref: "#/components/schemas/Candidate"

    DryRunRequest:
      type: object
      required: [migrationId, candidate, steps]
      description: >
        Payload the server sends to a migrator
        to execute a dry run. Contains all steps; the migrator skips steps
        that don't belong to it.
      properties:
        migrationId:
          type: string
        candidate:
          $ref: "#/components/schemas/Candidate"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/StepDefinition"

    # --- Worker callback ---

    EventResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
